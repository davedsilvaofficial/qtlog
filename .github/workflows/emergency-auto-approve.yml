name: Emergency Auto-Approve (Solo-Founder)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  approve:
    runs-on: ubuntu-latest
    steps:
      - name: Read PR metadata
        id: meta
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          pr="${{ github.event.pull_request.number }}"
          gh api "repos/${{ github.repository }}/pulls/${pr}" --jq '{
            number:.number,
            title:.title,
            body:(.body // ""),
            headRepo:.head.repo.full_name,
            baseRepo:.base.repo.full_name,
            headRef:.head.ref,
            headSha:.head.sha
          }' > pr.json
          cat pr.json

      - name: Gate (explicit + auditable + same-repo only + branch prefix)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          headRepo="$(jq -r .headRepo pr.json)"
          baseRepo="$(jq -r .baseRepo pr.json)"
          body="$(jq -r .body pr.json)"
          title="$(jq -r .title pr.json)"
          headRef="$(jq -r .headRef pr.json)"

          if [ "$headRepo" != "$baseRepo" ]; then
            echo "Not same-repo PR; refusing auto-approve."
            exit 0
          fi

          echo "$title $body" | grep -q "EMERGENCY-MODE:" || { echo "Missing EMERGENCY-MODE: marker; refusing."; exit 0; }

          echo "$headRef" | grep -Eq '^(emergency/|governance-|hotfix/)' || { echo "Head ref '$headRef' not allowed; refusing."; exit 0; }

          echo "Gate passed."

      - name: Gate (verify check must be SUCCESS)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          sha="$(jq -r .headSha pr.json)"

          # Query check runs on the PR head SHA and require "verify" to be SUCCESS
          concl="$(gh api "repos/${{ github.repository }}/commits/${sha}/check-runs"             -H "Accept: application/vnd.github+json"             --jq '[.check_runs[] | select(.name=="verify") | .conclusion][0] // empty')"

          if [ -z "$concl" ]; then
            echo "verify check-run not found on SHA ${sha}; refusing auto-approve."
            exit 0
          fi

          if [ "$concl" != "success" ]; then
            echo "verify is not success (got: $concl); refusing auto-approve."
            exit 0
          fi

          echo "verify is success."

      - name: Approve PR (bot review)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          pr="$(jq -r .number pr.json)"
          gh api -X POST "repos/${{ github.repository }}/pulls/${pr}/reviews"             -f event=APPROVE             -f body="Auto-approval: Emergency Mode criteria satisfied (EMERGENCY-MODE: present + verify green + same-repo + allowed branch)."
