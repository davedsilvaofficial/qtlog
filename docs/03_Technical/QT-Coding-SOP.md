# Quantum Trek – Coding SOP

## Related Governance Artifacts

### Governance Tree (Authoritative)


```

User Intent (Execute)

   │

   ▼

QT-Coding-SOP.md  ← root authority (why & rules)

   │

   ├─ CHANGELOG.md        ← auditable history (what changed)

   │    ▲

   │    │ (generated by)

   ├─ scripts/update-changelog.sh

   │

   ├─ qtlog.sh            ← operational behavior (what happens)

   │

   └─ .qtlog_env          ← runtime authorization only (who/keys)


Rules:

- SOP governs all behavior

- CHANGELOG audits all changes

- No Execute = no action

```


- `CHANGELOG.md` — auditable history of functional and governance changes (daily review anchor)
- `scripts/update-changelog.sh` — deterministic regeneration of the changelog header/format (if present)
- `docs/SOFTWARE_INVENTORY.md` — inventory and governance of executable artifacts

**Document Name:** `QT-Coding-SOP.md`  
**Version:** 1.0  
**Maintainer:** Quantum Trek CTO (Dave D’Silva)  
**Purpose:** Standard Operating Procedure for creating, maintaining, and executing the `qt-log-entry.sh` automation used to record timestamped log entries directly into the QT ▸ Log in Notion.

---

## 1. Scope
This SOP defines:
- Local file structure for Quantum Trek coding artifacts
- Installation and requirements
- Operational workflow to log entries into Notion
- Standard naming/timestamp conventions
- Repository and documentation structure

This SOP applies to all Quantum Trek projects using the logging automation:
1. QT SEC & Investor Filing
2. Master WBS & Systems Architecture

---

## 2. Local File Structure

Recommended folder layout (Linux / macOS):

```
~/projects/quantumtrek/
│
├── bin/
│   └── qt-log-entry.sh
│
├── docs/
│   └── QT-Coding-SOP.md
│   └── SEC-Filing-Notes.md
│   └── WBS-Master.md
│
├── env/
│   └── notion.env
│
└── repo/  (GitHub working directory)
```

**Paths referenced in this SOP:**
- Script: `~/projects/quantumtrek/bin/qt-log-entry.sh`
- SOP: `~/projects/quantumtrek/docs/QT-Coding-SOP.md`
- Environment file: `~/projects/quantumtrek/env/notion.env`

---

## 3. Environment Variables

The script requires two environment variables:

```
export NOTION_TOKEN="secret_XXXXX"
export NOTION_LOG_PAGE_ID="UUID"
```

Recommended storage: Create `~/projects/quantumtrek/env/notion.env`:

```
NOTION_TOKEN=secret_XXXXX
NOTION_LOG_PAGE_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
```

Load it from your shell profile:

```
source ~/projects/quantumtrek/env/notion.env
```

---

## 4. Log Format Standard

All log entries follow:
- **Date toggle:** `YYYY-MM-DD`  
- **Entry timestamp:** `YYYY-MM-DD HHMM — Description text`

Example:
```
2025-12-06
  └─ 2025-12-06 1432 — Submitted draft SEC filing outline
```

**Time standard:**  
- UTC: NOT used  
- Local timezone: **ET**  
- Format: **24-hour, 4-digit minute**  

This matches the Frontier Enterprise Standard used across Quantum Trek.

---

## 5. Execution Workflow

### Accepted Evidence Format (Operator-Approved)

- Operator-provided screenshot-to-text conversions (e.g., Gemini OCR) are accepted as valid proof.

- Line-number fidelity is NOT required if governance sections are legible.

- Validation responsibility remains with the assistant, not the operator.


### 5.0 Execution Gating & Proof (MANDATORY)

- **Preview Mode (Default):** Analysis, recommendations, and previews ONLY.
- **Execution Mode:** Any code, file, or repository change occurs **only** after the user explicitly replies with the exact word:

  Execute

- Agreement, selection of options, or conversational context **does NOT** imply execution.
- Absence of the word **Execute** means **NO ACTION**.
- The assistant must never assume execution from intent, urgency, or prior steps.
- **Proof is mandatory:** Every executed step must be followed by a command that produces unconditional output (e.g., `nl`, `grep`, `git show`).
- **No output = not executed**, regardless of claims.
- This rule exists to prevent accidental changes, silent regression, and operator burden.


### 5.1 Create or Update the Script
Open the script:

```bash
nano ~/projects/quantumtrek/bin/qt-log-entry.sh
```

Paste the complete script from the SOP appendix (Section 9).

Save and exit:

```
Ctrl + O → Enter
Ctrl + X
```

Make executable:

```bash
chmod +x ~/projects/quantumtrek/bin/qt-log-entry.sh
```

---

### 5.2 Run a Log Entry

**Inline usage:**

```bash
~/projects/quantumtrek/bin/qt-log-entry.sh "Updated WBS structure"
```

OR interactive prompt:

```bash
~/projects/quantumtrek/bin/qt-log-entry.sh
# then type the log text when prompted
```

---

## 6. GitHub Version Control

### 6.1 Initial Commit

Navigate to repo:

```bash
cd ~/projects/quantumtrek/repo/
```

Copy SOP into repo docs:

```bash
cp ~/projects/quantumtrek/docs/QT-Coding-SOP.md ./docs/
```

Stage & commit:

```bash
git add docs/QT-Coding-SOP.md
git commit -m "Add Quantum Trek coding SOP for qt-log-entry"
git push origin main
```

---

### 6.2 Update Workflow

When modifying the script:
1. Update the script in `bin/`
2. Update revision notes at the bottom of this SOP
3. Commit both with a message:

```
git commit -am "Improve qt-log-entry.sh timestamp validation"
git push
```

---

## 7. Document Control

**Version numbering:**
- Increment **minor version** for script updates
- Increment **major version** when SOP structure changes

**Changelog format:**
```
## 1.1 – 2025-01-17
- Added error handling for missing env
```

---

## 8. Notion Integration

The script uses the Notion Blocks API:
- URL: `https://api.notion.com/v1`
- Version: `2022-06-28`

Parent block for QT log is referenced using:
- `NOTION_LOG_PAGE_ID`

Nested toggle creation logic:
- If date toggle exists → append child
- If not → create toggle, then child

---

## 9. Appendix – Full Script

*(Paste your final, current version here. It will be maintained and updated under this section.)*

---


## I Revision History

```
Version 1.0 – 2025-12-06
- Initial SOP created
```

## Execution Discipline — Changelog First

## Execution Discipline — PREVIEW vs EXECUTE State Enforcement

**Rule:**
The assistant MUST explicitly operate in one of two states: **PREVIEW** or **EXECUTE**.
The default state is **PREVIEW**.

---

### PREVIEW State (Default)

- Purpose: Analysis, inspection, design, validation.
- Allowed:
  - Code reading
  - Diff review
  - Interface design
  - SOP drafting
  - Risk identification
- Prohibited:
  - Code modification
  - File writes
  - Git actions
  - Notion API calls
- Language requirement:
  - Assistant MUST state: “PREVIEW — no changes made.”

---

### EXECUTE State (Explicit Operator Authorization Required)

- Entry condition:
  - Operator must explicitly say **EXECUTE** and select a copy-ready action block.
- Requirements after EXECUTE:
  - Assistant MUST state expected code behavior.
  - Assistant MUST either:
    - Wait for a screenshot proving the result, OR
    - Provide an explicit command to verify correctness.
  - Assistant MUST stop and wait for verification input.

---

### Post-Execution Verification

After EXECUTE, the assistant MUST:
1. State what success looks like.
2. Request verification evidence.
3. Diagnose failures or confirm success.
4. Present future steps in PREVIEW mode.

---

**Violation Handling:**
- Proceeding without explicit EXECUTE authorization constitutes SOP drift.

**Rationale:**
- Prevents accidental changes
- Enforces operator authority
- Preserves auditability


## Execution Discipline — Explicit Choice Gating (Copy-Button Rule)

## Execution Discipline — Copy-Button Exclusivity

## Execution Discipline — Immediate Post-Change Verification

**Rule:**  
After ANY modification to code or documentation, the assistant MUST immediately require and perform a minimal verification test before proceeding.

**Requirements:**
- Verification MUST occur in the same interaction cycle as the change.
- Assistant MUST present a concrete verification command or request a screenshot/output.
- Assistant MUST explicitly wait for verification before proposing next steps.
- No roadmap or follow-on work may be executed until verification succeeds.

**Rationale:**
- Prevents silent regressions.
- Enforces correctness over momentum.
- Creates an auditable proof-of-work trail.

**Enforcement:**
- Skipping verification is an SOP violation.
- Operator may halt execution immediately.
- Assistant must restate verification steps before continuing.



**Rule:**  
All options presented by the assistant MUST be delivered inside copy-ready command blocks. Manual copying by the operator is prohibited.


**Requirements:**

- Every option MUST be enclosed in its own copy-button block.

- No option may rely on manual text selection or re-typing.

- No mixed prose + commands inside a block.

- One block = one executable intent.

- If a choice cannot be safely expressed as a copy-button block, it MUST NOT be presented.


**Rationale:**

- Prevents transcription errors.

- Preserves execution integrity.

- Maintains deterministic behavior.

- Ensures auditability and reproducibility.


**Enforcement:**

- Any response presenting options outside copy-button blocks is an SOP violation.

- Operator may halt execution immediately.

- Assistant must restate options correctly before proceeding.


## Execution Discipline — PREVIEW vs EXECUTE State Enforcement

**Rule:**
The assistant MUST explicitly operate in one of two states: **PREVIEW** or **EXECUTE**.
The default state is **PREVIEW**.

---

### PREVIEW State (Default)

- Purpose: Analysis, inspection, design, validation.
- Allowed:
  - Code reading
  - Diff review
  - Interface design
  - SOP drafting
  - Risk identification
- Prohibited:
  - Code modification
  - File writes
  - Git actions
  - Notion API calls
- Language requirement:
  - Assistant MUST state: “PREVIEW — no changes made.”

---

### EXECUTE State (Explicit Operator Authorization Required)

- Entry condition:
  - Operator must explicitly say **EXECUTE** and select a copy-ready action block.
- Requirements after EXECUTE:
  - Assistant MUST state expected code behavior.
  - Assistant MUST either:
    - Wait for a screenshot proving the result, OR
    - Provide an explicit command to verify correctness.
  - Assistant MUST stop and wait for verification input.

---

### Post-Execution Verification

After EXECUTE, the assistant MUST:
1. State what success looks like.
2. Request verification evidence.
3. Diagnose failures or confirm success.
4. Present future steps in PREVIEW mode.

---

**Violation Handling:**
- Proceeding without explicit EXECUTE authorization constitutes SOP drift.

**Rationale:**
- Prevents accidental changes
- Enforces operator authority
- Preserves auditability



**Rule:**  
When presenting multiple actions, branches, or decisions, the assistant MUST present each choice inside a copy-ready block (single-action or numbered options). No implied execution.


**Requirements:**

- All choices MUST be isolated in copyable blocks.

- Each block MUST represent one discrete action or decision.

- No action proceeds unless the operator explicitly selects a block (e.g., “Execute Option 2”).

- No mixed narration + instructions inside a block.

- Default state is **NO ACTION**.


**Rationale:**

- Prevents accidental execution.

- Reduces cognitive load.

- Preserves operator authority.

- Maintains auditability and governance integrity.


**Enforcement:**

- Any response that presents choices without copy-ready blocks constitutes SOP drift.

- Operator may halt execution if this rule is violated.


**Applies To:**

- CLI commands

- Git operations

- Notion changes

- Infrastructure edits

- Multi-step plans

- Refactors or migrations


**Rule:** Before writing or editing code, first scan existing repo history to prevent duplicate work.

**Required checks (in order):**
- `git log -n 30 --oneline -- qtlog.sh`
- `git diff --name-only HEAD~1..HEAD` (when applicable)
- `grep -n` scan of target sections before edits

**Rationale:** Avoids re-implementing existing functionality, reduces regressions, and reduces operator burden.

---

## LKG Snapshot — v1.2.0-notion-fix (Notion Write Stabilization)

**Status:** Locked / Known-Last-Good
**Git Tag:** `v1.2.0-notion-fix`
**Branch Baseline:** `main`
**Date Locked:** 2025-12-15

### Purpose
Establish a stable, auditable baseline for Notion ToDo writes using the official API endpoint:
- `PATCH /v1/blocks/{block_id}/children`

### What Changed
- Fixed invalid Notion write endpoint usage.
- Standardized Notion writes to the official `/blocks/{id}/children` endpoint.
- Corrected ToDo block discovery and ensured the correct parent block is used.

### Verification
- Confirmed a test entry appears as a child under the correct Notion ToDo heading.


## QT Environment Configuration

All QT automation scripts load environment variables from:

    ~/.config/qt/.env

This file contains:
- NOTION_API_KEY
- NOTION_LOG_PAGE_ID
- NOTION_TODO_PAGE_ID

If Notion logging or Todo writing fails, inspect this file first.

---


## Canonical Notion Entry Invariant (CEI)

All Notion entries written by **qtlog** — including **Log** and **ToDo** — MUST satisfy the following invariant:

### Structural requirements
- The entry **MUST** be a **toggle block**
- The toggle title **MUST** use the format:
  `YYYY-MM-DD HHMM [Device] <description>`
- The toggle **MUST** contain child paragraphs:
  - Work done
  - Notes
  - Next steps

### Scope
- **Log** and **ToDo** differ only by **parent container**.
- Any deviation is considered **structural drift**.



## Verify Mode (--verify)
- Purpose: read-only verification that newest-at-top anchors exist and that qtlog is using authoritative ET time.
- Output: always prints `VERIFY_TIME=YYYY-MM-DD HHMM ET`.
- If Notion env is missing (`NOTION_API_KEY` or `NOTION_LOG_PAGE_ID`), prints `VERIFY_SKIP=missing_env` and exits 0.
- With Notion env present, prints:
  - `H1_FIRST=...` (first child under Log H1)
  - `DAY_FIRST=...` and `DAY_SECOND=...` (first/second child under today’s day toggle)
