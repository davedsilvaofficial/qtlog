#!/usr/bin/env bash
set -euo pipefail

# 1) qtlog.sh must be valid bash
bash -n qtlog.sh

# 2) SOP must contain required sections
SOP="docs/03_Technical/qtlog_best_practices_sop.md"
[ -f "$SOP" ] || { echo "ERROR: missing $SOP" >&2; exit 1; }

grep -q "### 3) Notion Payload Safety (Large Logs)" "$SOP" || {
  echo "ERROR: SOP missing Section 3 Notion Payload Safety" >&2; exit 1;
}
grep -q "Recovery Checklist (When Termux Hangs)" "$SOP" || {
  echo "ERROR: SOP missing Recovery Checklist" >&2; exit 1;
}

# 3) Guard against committing a broken heredoc marker we rely on
grep -q "### QTLOG_NOTION_BIGPAYLOAD_HELPERS ###" qtlog.sh || {
  echo "ERROR: qtlog.sh missing QTLOG_NOTION_BIGPAYLOAD_HELPERS marker" >&2; exit 1;
}
grep -q "### QTLOG_NOTION_ENTRY_PATCH ###" qtlog.sh || {
  echo "ERROR: qtlog.sh missing QTLOG_NOTION_ENTRY_PATCH marker" >&2; exit 1;
}

echo "pre-commit OK"
